<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.4.1"><title>ML model - SaaS Big Data Demo</title><link rel=stylesheet href=../assets/stylesheets/main.69437709.min.css><link rel=stylesheet href=../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#company-churn-assess-ai-model-development-with-sagemaker class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="SaaS Big Data Demo" class="md-header__button md-logo" aria-label="SaaS Big Data Demo" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> SaaS Big Data Demo </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> ML model </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jbcodeforce/big-data-tenant-analytics.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="SaaS Big Data Demo" class="md-nav__button md-logo" aria-label="SaaS Big Data Demo" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> SaaS Big Data Demo </label> <div class=md-nav__source> <a href=https://github.com/jbcodeforce/big-data-tenant-analytics.git title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../dashboard/ class=md-nav__link> Business Dashboard </a> </li> <li class=md-nav__item> <a href=../design/ class=md-nav__link> Architecture & Design </a> </li> <li class=md-nav__item> <a href=../eks/ class=md-nav__link> EKS </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> ML model <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> ML model </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=#preparing-the-data class=md-nav__link> Preparing the data </a> <nav class=md-nav aria-label="Preparing the data"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#run-the-simulator class=md-nav__link> Run the simulator </a> </li> <li class=md-nav__item> <a href=#simulator-code-explanations class=md-nav__link> Simulator code explanations </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#upload-generated-files-to-s3 class=md-nav__link> Upload generated files to S3 </a> <nav class=md-nav aria-label="Upload generated files to S3"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pre-requisites class=md-nav__link> Pre-requisites </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#build-and-deploy-the-model-with-aws-sagemaker class=md-nav__link> Build and deploy the model with AWS SageMaker </a> <nav class=md-nav aria-label="Build and deploy the model with AWS SageMaker"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#deeper-dive-build-model class=md-nav__link> Deeper dive: build model </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#read-more class=md-nav__link> Read more </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../api-lambda/ class=md-nav__link> API Gateway - Lambda </a> </li> <li class=md-nav__item> <a href=../rt-analytics/ class=md-nav__link> RT Analytics </a> </li> <li class=md-nav__item> <a href=../java-apps/ class=md-nav__link> Tenant Manager </a> </li> <li class=md-nav__item> <a href=../cdk/ class=md-nav__link> Infrastructure as code </a> </li> <li class=md-nav__item> <a href=https://jbcodeforce.github.io/aws-studies/ class=md-nav__link> AWS studies </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=#preparing-the-data class=md-nav__link> Preparing the data </a> <nav class=md-nav aria-label="Preparing the data"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#run-the-simulator class=md-nav__link> Run the simulator </a> </li> <li class=md-nav__item> <a href=#simulator-code-explanations class=md-nav__link> Simulator code explanations </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#upload-generated-files-to-s3 class=md-nav__link> Upload generated files to S3 </a> <nav class=md-nav aria-label="Upload generated files to S3"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pre-requisites class=md-nav__link> Pre-requisites </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#build-and-deploy-the-model-with-aws-sagemaker class=md-nav__link> Build and deploy the model with AWS SageMaker </a> <nav class=md-nav aria-label="Build and deploy the model with AWS SageMaker"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#deeper-dive-build-model class=md-nav__link> Deeper dive: build model </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#read-more class=md-nav__link> Read more </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/jbcodeforce/big-data-tenant-analytics.git/edit/master/docs/model.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=company-churn-assess-ai-model-development-with-sagemaker>Company Churn assess AI model development with SageMaker<a class=headerlink href=#company-churn-assess-ai-model-development-with-sagemaker title="Permanent link">&para;</a></h1> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p>The goal of this service is to compute the risk for a customer to leave the SaaS platform. The scoring takes into account the industry type, the company size in term of revenue and number of employees, and then specifics features from the SaaS business model. In our case we will take a company doing big data job management so we can add variables: number of jobs in last 30 days, and 90 days, monthly charge, total charge, number of time tutorials were done so far cross all users. </p> <p>Here is simple example of training data: (Revenue is in million $)</p> <div class=highlight><pre><span></span><code>Company,Industry,Revenue,Employees,#job30,#job90,MonthlyCharge,TotalCharge,Churn
comp_0,travel,9270,4635,3,56,446,1476,1
comp_1,finance,99420,49710,7,97,424,3039,0
comp_2,gov,83410,27803,7,66,1128,1422,0
comp_3,service,59650,19883,5,58,967,3661,0
comp_4,retail,29080,14540,4,13,461,1172,1
comp_5,finance,83590,20898,5,75,472,3735,0
comp_6,retail,86080,28693,9,85,824,4475,1
</code></pre></div> <p>The following figure illustrates how to build the model using Amazon SageMaker (in green the components developed in this solution) using training and test data sets and then deployed model in a scalable runtime:</p> <p><img alt src=../diagrams/sagemaker-training.drawio.png></p> <p><strong>Figure 1: SageMaker Model Training and Runtime deployment</strong> </p> <p>The runtime is exposing an Endpoint that we can access using ASW SDK from a lambda or a microservice , or Kinesis Data Analytics. </p> <p>To train the model we use a predefined algorithm, packaged as docker image, and available inside SageMaker notebook, via access to Amazon Elastic Container Registry.</p> <p>This repository includes a <a href=https://github.com/jbcodeforce/big-data-tenant-analytics/blob/main/CompanyRisk/CompanyDataGenerator.py>Simulator (CompanyDataGenerator.py)</a> to generate data to build training set. The generated records can be uploaded to S3 via AWS CLI. It also includes a <a href=https://github.com/jbcodeforce/big-data-tenant-analytics/blob/main/CompanyRisk/company-churn-sm.ipynb>SageMaker notebook (company-churn-sm.ipynb)</a> that can be executed in AWS SageMaker Studio to perform some simple feature engineering, train the model, and deploy the model to SageMaker runtime so it can be called from any clients which has the endpoint information.</p> <h2 id=preparing-the-data>Preparing the data<a class=headerlink href=#preparing-the-data title="Permanent link">&para;</a></h2> <p>Within this repository under the <a href=https://github.com/jbcodeforce/big-data-tenant-analytics/tree/main/CompanyRisk>CompanyRisk folder</a> there is a simple Python program to be used to generate random data of companies within industry, with revenue, number of employees, # of jobs submitted the last 30 days, 90 days, current monthly fees and accumulated fees. </p> <p>The <a href=https://github.com/jbcodeforce/big-data-tenant-analytics/blob/main/CompanyRisk/companies.csv>companies.csv</a> file was already created from a previous run and can be used as source for training.</p> <h3 id=run-the-simulator>Run the simulator<a class=headerlink href=#run-the-simulator title="Permanent link">&para;</a></h3> <p>If you want to re-run the simulator you can do the following steps.</p> <ol> <li> <p>Be sure to have last AWS CLI and python library. You can use <a href>AWS Powershell</a> and clone this repository, or if you use your own computer, you can use a docker image built from a dockerfile in <a href=https://github.com/jbcodeforce/aws-studies/tree/main/labs>aws-studies labs folder</a>:</p> <div class=highlight><pre><span></span><code>docker build -f https://raw.githubusercontent.com/jbcodeforce/aws-studies/main/labs/Dockerfile -t jbcodeforce/aws-python .
</code></pre></div> </li> <li> <p>Start the python environment with docker, mounting the source code to <code>/app</code>:</p> <div class=highlight><pre><span></span><code>docker run --rm  --name pythonapp -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>:/app -v ~/.aws:/root/.aws -it  -p <span class=m>5000</span>:5000 jbcodeforce/aws-python bash
</code></pre></div> </li> <li> <p>Run the data generator:</p> <div class=highlight><pre><span></span><code>python CompanyDataGenerator.py companies.csv --nb_records <span class=m>10000</span>
</code></pre></div> <p>This should create <code>companies.csv</code> file with 10,000 rows</p> </li> </ol> <h3 id=simulator-code-explanations>Simulator code explanations<a class=headerlink href=#simulator-code-explanations title="Permanent link">&para;</a></h3> <ul> <li>Use argparser to define the argument for the command line.</li> <li>Generate nb_records row: company has unique id, industry is selected randomly, revenue and number of employee is linked to the revenue.</li> <li>Churn flag is set to 1 if revenue is low.</li> <li>Use <code>csv</code> library to write the csv file.</li> </ul> <h2 id=upload-generated-files-to-s3>Upload generated files to S3<a class=headerlink href=#upload-generated-files-to-s3 title="Permanent link">&para;</a></h2> <h3 id=pre-requisites>Pre-requisites<a class=headerlink href=#pre-requisites title="Permanent link">&para;</a></h3> <ol> <li> <p>Be sure to have an IAM role with S3FullAccess. The name of the role is ()</p> <p><img alt src=../images/s3-policy.png></p> </li> <li> <p>Get Access Key and Secret key and configuge aws, we specific profile: <code>aws configure --profile s3admin</code></p> </li> <li> <p>Verify you can access s3 using: <code>aws s3 ls</code>. Use the command:</p> <div class=highlight><pre><span></span><code>aws s3 cp <span class=nv>$PWD</span>/companies.csv s3://jb-data-set/churn/companies.csv  --profile s3admin
</code></pre></div> </li> <li> <p>[Alternate] Start the Python 3 environment using docker</p> <div class=highlight><pre><span></span><code>docker run --rm  --name pythonapp -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>:/app -v ~/.aws:/root/.aws -it  -p <span class=m>5000</span>:5000 jbcodeforce/aws-python bash
</code></pre></div> <ul> <li>Using the python code and boto3 library do the following:</li> </ul> <div class=highlight><pre><span></span><code>python copyToS3.py us-west-2 jb-data-set churn <span class=nv>$PWD</span>/companies.csv 
</code></pre></div> <ul> <li>If some libraries are not installed do <code>pip install -r requirements.txt</code></li> </ul> </li> </ol> <h2 id=build-and-deploy-the-model-with-aws-sagemaker>Build and deploy the model with AWS SageMaker<a class=headerlink href=#build-and-deploy-the-model-with-aws-sagemaker title="Permanent link">&para;</a></h2> <p>The goal of this section is to build the churn predictive scoring model within SageMaker. The steps are simple:</p> <ol> <li>Create or use your SageMaker Studio, <a href=https://catalog.us-east-1.prod.workshops.aws/workshops/63069e26-921c-4ce1-9cc7-dd882ff62575/en-US/prerequisites/option2>here are workshop instructions</a> to do so.</li> <li>Be sure to have an IAM role for SageMaker to access remote services like S3. </li> <li> <p>In the folder manager create a new folder named <code>SaaS-company-churn</code> and then upload the <code>companies.csv</code> file and the SageMaker Notebook <a href=https://github.com/jbcodeforce/big-data-tenant-analytics/blob/main/CompanyRisk/company-churn-sm.ipynb>company-churn-sm.ipynb</a></p> <p><img alt src=../images/notebook-in-sm.png></p> </li> <li> <p>Executes the steps one by one or all of them, it should create the training set, test sets, build and deploy the model using the SageMaker Python API. </p> </li> <li> <p>Be sure to keep a copy of the name of the service endpoint as it is needed for the client to call this service in future steps.</p> </li> </ol> <h3 id=deeper-dive-build-model>Deeper dive: build model<a class=headerlink href=#deeper-dive-build-model title="Permanent link">&para;</a></h3> <p>The notebook work is quite simple: remove unnecessary columns, transform categorical features to one hot columns. Split 20% of the records to build a test set, the rest being the training set.</p> <div class=highlight><pre><span></span><code><span class=n>industryCat</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s2>&quot;Industry&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span>
<span class=n>industry_type</span> <span class=o>=</span> <span class=n>CategoricalDtype</span><span class=p>(</span><span class=n>categories</span><span class=o>=</span><span class=n>industryCat</span><span class=p>)</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>drop</span><span class=p>([</span><span class=s1>&#39;Company&#39;</span><span class=p>],</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
<span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>get_dummies</span><span class=p>(</span><span class=n>df</span><span class=p>,</span><span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;Industry&#39;</span><span class=p>])</span>
<span class=c1># SageMaker requires that a CSV file does not have a header record and that the target variable is in the first column. </span>
<span class=n>cols</span><span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>columns</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
<span class=n>cols</span> <span class=o>=</span> <span class=p>[</span><span class=n>cols</span><span class=p>[</span><span class=mi>6</span><span class=p>]]</span><span class=o>+</span><span class=n>cols</span><span class=p>[:</span><span class=mi>5</span><span class=p>]</span><span class=o>+</span><span class=n>cols</span><span class=p>[</span><span class=mi>7</span><span class=p>:]</span>
<span class=n>df</span><span class=o>=</span><span class=n>df</span><span class=p>[</span><span class=n>cols</span><span class=p>]</span>
<span class=n>train_data</span><span class=p>,</span> <span class=n>test_data</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>df</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>frac</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>1729</span><span class=p>),</span> <span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=mf>0.8</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)),</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)])</span>
<span class=n>train_data</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=s1>&#39;train.csv&#39;</span><span class=p>,</span> <span class=n>header</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<span class=n>test_data</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=s1>&#39;test.csv&#39;</span><span class=p>,</span> <span class=n>header</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</code></pre></div> <p>Using Python AWS SDK named boto3, we can upload the created data sets to S3 bucket </p> <div class=highlight><pre><span></span><code><span class=n>boto3</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span><span class=o>.</span><span class=n>resource</span><span class=p>(</span><span class=s1>&#39;s3&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>Bucket</span><span class=p>(</span><span class=n>data_bucket</span><span class=p>)</span><span class=o>.</span><span class=n>Object</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>PREFIX</span><span class=p>,</span> <span class=s1>&#39;train/train.csv&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>upload_file</span><span class=p>(</span><span class=s1>&#39;train.csv&#39;</span><span class=p>)</span>
<span class=n>boto3</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span><span class=o>.</span><span class=n>resource</span><span class=p>(</span><span class=s1>&#39;s3&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>Bucket</span><span class=p>(</span><span class=n>data_bucket</span><span class=p>)</span><span class=o>.</span><span class=n>Object</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>PREFIX</span><span class=p>,</span> <span class=s1>&#39;validation/test.csv&#39;</span><span class=p>))</span><span class=o>.</span><span class=n>upload_file</span><span class=p>(</span><span class=s1>&#39;test.csv&#39;</span><span class=p>)</span>
</code></pre></div> <p>and then use sagemaker SDK to define input and validation sets:</p> <div class=highlight><pre><span></span><code><span class=n>train_data</span> <span class=o>=</span> <span class=n>sagemaker</span><span class=o>.</span><span class=n>inputs</span><span class=o>.</span><span class=n>TrainingInput</span><span class=p>(</span>
    <span class=n>s3_train_data</span><span class=p>,</span>
    <span class=n>distribution</span><span class=o>=</span><span class=s2>&quot;FullyReplicated&quot;</span><span class=p>,</span>
    <span class=n>content_type</span><span class=o>=</span><span class=s2>&quot;text/csv&quot;</span><span class=p>,</span>
    <span class=n>s3_data_type</span><span class=o>=</span><span class=s2>&quot;S3Prefix&quot;</span><span class=p>,</span>
    <span class=n>record_wrapping</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
    <span class=n>compression</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
<span class=p>)</span>
<span class=n>validation_data</span> <span class=o>=</span> <span class=n>sagemaker</span><span class=o>.</span><span class=n>inputs</span><span class=o>.</span><span class=n>TrainingInput</span><span class=p>(</span>
    <span class=n>s3_validation_data</span><span class=p>,</span>
    <span class=n>distribution</span><span class=o>=</span><span class=s2>&quot;FullyReplicated&quot;</span><span class=p>,</span>
    <span class=n>content_type</span><span class=o>=</span><span class=s2>&quot;text/csv&quot;</span><span class=p>,</span>
    <span class=n>s3_data_type</span><span class=o>=</span><span class=s2>&quot;S3Prefix&quot;</span><span class=p>,</span>
    <span class=n>record_wrapping</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
    <span class=n>compression</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
<span class=p>)</span>
</code></pre></div> <p>As illustrated in figure above, we are using pre-build algorithm in the form of SageMaker container image:</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>sagemaker.image_uris</span> <span class=kn>import</span> <span class=n>retrieve</span>

<span class=n>container</span> <span class=o>=</span> <span class=n>retrieve</span><span class=p>(</span><span class=s2>&quot;linear-learner&quot;</span><span class=p>,</span> <span class=n>boto3</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span><span class=o>.</span><span class=n>region_name</span><span class=p>,</span> <span class=n>version</span><span class=o>=</span><span class=s2>&quot;1&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>container</span><span class=p>)</span>
</code></pre></div> <p>And then fit the model by using an <a href=https://sagemaker.readthedocs.io/en/stable/algorithms/tabular/linear_learner.html>LinearLearner</a> estimator as a supervised learning algorithms used for solving classification or regression problems.</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>time</span> <span class=kn>import</span> <span class=n>gmtime</span><span class=p>,</span> <span class=n>strftime</span>
<span class=n>job_name</span> <span class=o>=</span> <span class=s2>&quot;Linear-learner-company-churn-&quot;</span> <span class=o>+</span> <span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;%H-%M-%S&quot;</span><span class=p>,</span> <span class=n>gmtime</span><span class=p>())</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Training job&quot;</span><span class=p>,</span> <span class=n>job_name</span><span class=p>)</span>

<span class=n>linear</span> <span class=o>=</span> <span class=n>sagemaker</span><span class=o>.</span><span class=n>estimator</span><span class=o>.</span><span class=n>Estimator</span><span class=p>(</span>
    <span class=n>container</span><span class=p>,</span>
    <span class=n>role</span><span class=p>,</span>
    <span class=n>input_mode</span><span class=o>=</span><span class=s2>&quot;File&quot;</span><span class=p>,</span>
    <span class=n>instance_count</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
    <span class=n>instance_type</span><span class=o>=</span><span class=s2>&quot;ml.m4.xlarge&quot;</span><span class=p>,</span>
    <span class=n>output_path</span><span class=o>=</span><span class=n>output_location</span><span class=p>,</span>
    <span class=n>sagemaker_session</span><span class=o>=</span><span class=n>sess</span><span class=p>,</span>
<span class=p>)</span>

<span class=n>linear</span><span class=o>.</span><span class=n>set_hyperparameters</span><span class=p>(</span>
    <span class=n>epochs</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span>
    <span class=n>wd</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>
    <span class=n>loss</span><span class=o>=</span><span class=s2>&quot;absolute_loss&quot;</span><span class=p>,</span>
    <span class=n>predictor_type</span><span class=o>=</span><span class=s2>&quot;binary_classifier&quot;</span><span class=p>,</span>
    <span class=n>normalize_data</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
    <span class=n>optimizer</span><span class=o>=</span><span class=s2>&quot;adam&quot;</span><span class=p>,</span>
    <span class=n>mini_batch_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
    <span class=n>lr_scheduler_step</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
    <span class=n>lr_scheduler_factor</span><span class=o>=</span><span class=mf>0.99</span><span class=p>,</span>
    <span class=n>lr_scheduler_minimum_lr</span><span class=o>=</span><span class=mf>0.0001</span><span class=p>,</span>
    <span class=n>learning_rate</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
<span class=p>)</span>
<span class=n>linear</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>inputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;train&quot;</span><span class=p>:</span> <span class=n>train_data</span><span class=p>,</span> <span class=s2>&quot;validation&quot;</span><span class=p>:</span> <span class=n>validation_data</span><span class=p>},</span> <span class=n>job_name</span><span class=o>=</span><span class=n>job_name</span><span class=p>)</span>
</code></pre></div> <ul> <li>Deploy the model with the following code:</li> </ul> <div class=highlight><pre><span></span><code><span class=n>linear_predictor</span> <span class=o>=</span> <span class=n>linear</span><span class=o>.</span><span class=n>deploy</span><span class=p>(</span><span class=n>initial_instance_count</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>instance_type</span><span class=o>=</span><span class=s2>&quot;ml.c4.xlarge&quot;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>created endpoint: </span><span class=si>{</span><span class=n>linear_predictor</span><span class=o>.</span><span class=n>endpoint_name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=nv>Be</span><span class=w> </span><span class=nv>sure</span><span class=w> </span><span class=nv>to</span><span class=w> </span><span class=nv>keep</span><span class=w> </span><span class=nv>the</span><span class=w> </span><span class=nv>name</span><span class=w> </span><span class=nv>of</span><span class=w> </span><span class=nv>the</span><span class=w> </span><span class=nv>endpoint</span>,<span class=w> </span><span class=nv>as</span><span class=w> </span><span class=nv>we</span><span class=w> </span><span class=nv>will</span><span class=w> </span><span class=nv>need</span><span class=w> </span><span class=nv>it</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=nv>the</span><span class=w> </span><span class=nv>lambda</span>.<span class=w></span>
</code></pre></div> <ul> <li>We can try some prediction in the notebook using cless like:</li> </ul> <div class=highlight><pre><span></span><code><span class=n>payload</span><span class=o>=</span><span class=s2>&quot;19100,9550,6,39,227,810,0,0,0,0,0,0,1,0&quot;</span>
<span class=n>result</span><span class=o>=</span><span class=n>linear_predictor</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
<span class=c1># Result looks like:</span>
<span class=p>{</span><span class=s1>&#39;predictions&#39;</span><span class=p>:</span> <span class=p>[{</span><span class=s1>&#39;score&#39;</span><span class=p>:</span> <span class=mf>0.985599935054779</span><span class=p>,</span> <span class=s1>&#39;predicted_label&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>}]}</span>
</code></pre></div> <p>Or using a python client, you can run inside a EC2 or on your computer see code <a href=https://github.com/jbcodeforce/big-data-tenant-analytics/blob/main/CompanyRisk/CallSageMakerRunTime.py>CompanyRisk/CallSageMakerRunTime.py</a>, be sure to set the ENDPOINT variable to the SageMaker endpoint name. </p> <p>The URL is not public, but could also being accessed via an HTTP POST from an EC2 in the same VPC.</p> <h2 id=read-more>Read more<a class=headerlink href=#read-more title="Permanent link">&para;</a></h2> <ul> <li><a href=https://sagemaker.readthedocs.io/en/stable/algorithms/tabular/linear_learner.html>SageMaker - Linear Learner</a></li> <li><a href=https://docs.aws.amazon.com/sagemaker/latest/dg/cdf-training.html>SageMaker - Common Data Formats for Training</a></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../eks/ class="md-footer__link md-footer__link--prev" aria-label="Previous: EKS" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> EKS </div> </div> </a> <a href=../api-lambda/ class="md-footer__link md-footer__link--next" aria-label="Next: API Gateway - Lambda" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> API Gateway - Lambda </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "content.tooltips", "navigation.instant", "navigation.tracking", "navigation.tabs.sticky"], "search": "../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.9c69f0bc.min.js></script> </body> </html>